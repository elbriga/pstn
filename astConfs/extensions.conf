; database put config/gabriel CID 4133225566
; database put config/gabriel ocupado 8
; database put config/gabriel naoAtende 6
; database put config/gabriel secEletr 10
; database put config/gabriel mohMin 10
; database put config/gabriel mohMax 50
; database put config/gabriel congestion 3

[default]
include => pstn

; Tronco com o PABX Nexcore para acesso aos clientes
[sede]
; Teste de Eco Local
exten => 1234,1,Answer()
exten => 1234,2,Playback(beep)
exten => 1234,3,Echo()

include => acesso-a-clientes-por-id


; CLIENTES:
; --------
[acesso-a-clientes-por-id]
; Papel Magia - ID 1105
exten => _1105.,1,Macro(acessoCli,${EXTEN:4},papelmagia)

[macro-acessoCli]
exten => s,1,Dial(SIP/${ARG1}@${ARG2},60,tT)

; alias de saidaParaVMs
[teste]
include => saidaParaVMs

;
; Contexto para gerar ligacoes entrantes nas VMs de desenvolvimento
; Uso: channel originate Local/[aliasVM][NUMERO entrante VM]@saidaParaVMs [application/extension] [app ou exten]
;
; Exemplo: channel originate Local/gab1235@saidaParaVMs application MusicOnHold
; Neste caso ira para Musica de Espera indefinidamente
;
[saidaParaVMs]
exten => _gabX.,1,Set(CALLERID(num)=4133225567)
exten => _gabX.,n,Dial(SIP/${EXTEN:3}@gabriel,60)

exten => _rafX.,1,Set(CALLERID(num)=41992411994)
exten => _rafX.,n,Dial(SIP/${EXTEN:3}@vm-raf,60)

exten => _jerX.,1,Set(CALLERID(num)=4130850009)
exten => _jerX.,n,Dial(SIP/${EXTEN:3}@vm-jer,60)

exten => _junX.,1,Set(CALLERID(num)=41991236487)
exten => _junX.,n,Dial(SIP/${EXTEN:3}@10.3.0.180,60)

exten => _sedX.,1,Set(CALLERID(num)=4133225566)
exten => _sedX.,n,Dial(SIP/${EXTEN:3}@10.0.0.2,60)

exten => _homX.,1,Set(CALLERID(num)=${CID})
exten => _homX.,n,Dial(SIP/${EXTEN:3}@vm-hom,60)

exten => _sedeX.,1,Set(CALLERID(num)=${CID})
exten => _sedeX.,n,Dial(SIP/${EXTEN:4}@sede,60)

exten => _sa1X.,1,Set(CALLERID(num)=${CID})
exten => _sa1X.,n,Dial(SIP/${EXTEN:3}@10.3.0.120,60)

exten => _sa2X.,1,Set(CALLERID(num)=${CID})
exten => _sa2X.,n,Dial(SIP/${EXTEN:3}@10.3.0.124,60)

exten => _vm212X.,1,Set(CALLERID(num)=${CID})
exten => _vm212X.,n,Dial(SIP/${EXTEN:3}@vm212,60)

exten => _teste1X.,1,Set(CALLERID(num)=${CID})
exten => _teste1X.,n,Dial(SIP/${EXTEN:6}@10.1.0.199,60)

exten => _amjad1X.,1,Set(CALLERID(all)=4133221336)
exten => _amjad1X.,n,Dial(SIP/${EXTEN:6}@10.3.0.211,60)

exten => _copelX.,1,Set(CALLERID(num)=41991416551)
exten => _copelX.,n,Dial(SIP/${EXTEN:5}@10.1.0.218,60)

exten => _diegoX.,1,Set(CALLERID(num)=41992497951)
exten => _diegoX.,n,Dial(SIP/${EXTEN:5}@10.3.0.173,60)

exten => _diegiX.,1,Set(CALLERID(num)=41992497951)
exten => _diegiX.,n,Dial(SIP/${EXTEN:5}@10.0.0.202,60)


exten => _manikaX.,1,Set(CALLERID(num)=41992497951)
exten => _manikaX.,n,Dial(SIP/${EXTEN:5}@10.3.0.28,60)

[pstn]
exten => _1XX,1,Macro(simula-pstn,ligacao-servico)
exten => _1XXXX,1,Macro(simula-pstn,ligacao-servico)
exten => _0[3489]00XXXX.,1,Macro(simula-pstn,ligacao-0800)
exten => _[2-5]XXXXXXX,1,Macro(simula-pstn,ligacao-fixo-local)
exten => _[6-9]XXXXXXX,1,Macro(simula-pstn,ligacao-movel-local)
exten => _9XXXXXXXX,1,Macro(simula-pstn,ligacao-movel-local)
exten => _0XXXX[2-5]XXXXXXX,1,Macro(simula-pstn,ligacao-fixo-ddd)
exten => _0XXXX[6-9]XXXXXXX,1,Macro(simula-pstn,ligacao-movel-ddd)
exten => _0XXXX9XXXXXXXX,1,Macro(simula-pstn,ligacao-movel-ddd)
exten => _00XXXX.,1,Macro(simula-pstn,ligacao-ddi)
exten => _XXX.,1,Macro(simula-pstn,ligacao-nao-identificado)


[macro-simula-pstn-0]
; descomentar abaixo para atender todas as chamadas
;exten => s,1(humano),NoOp(atendimento-humano)
;exten => s,n,Ringing
;exten => s,n,Wait(5)
;exten => s,n,Hangup(1) ;NOT FOUND
;exten => s,n,Hangup(21) ;FORBIDDEN
;exten => s,n,Hangup(17)
;exten => s,n,Busy()
;exten => s,n,Answer()
;exten => s,n,Playback(atendimento-maquina)
;exten => s,n,Playback(atendimento-humano)
;exten => s,n,Wait(500)
;exten => s,n,Goto(moh)
;exten => s,n,answer()
;exten => s,n,Playtones(congestion)
;exten => s,n,congestion()

[macro-simula-pstn]
; simular o desempenho do mailing de acordo com as metricas:
; 20% - Atendimento humano
; 20% - Secretaria eletronica
; 20% - Mensagem operadora
; 10% - N達o atende
; 20% - Ocupado
; 10% - N達o existe
exten => s,1,NoOp(Simulando desempenho do mailing - cid:${CALLERID(num)} - chan:${CHANNEL})

exten => s,n,Set(RND=${RAND(1,100)})
;exten => s,n,Set(RND=99) ; 100% - Atendimento humano 
;exten => s,n,Set(RND=9)  ; 100% - Ocupado
;exten => s,n,Set(RND=20) ; 100% - N達o Existe
;exten => s,n,Set(RND=45) ; 100% - Secretaria Eletronica. 
;exten => s,n,Set(RND=70) ; 100% - N達o Atende. 
;exten => s,n,Set(RND=80) ; 100% - Descarte


;; Chamadas vindas de IP especifico 
exten => s,n,ExecIf($[ "${REGEX("10\.3\.0\.2-" ${CHANNEL})}" == "1" ]?Set(RND=9))
;exten => s,n,ExecIf($[ "${REGEX("10\.3\.0\.25-" ${CHANNEL})}" == "1" ]?Set(RND=55))

exten => s,n,GotoIf($[ ${RND} < 10 ]?simula-ocupado)
exten => s,n,GotoIf($[ ${RND} < 25 ]?simula-naoexiste)
exten => s,n,GotoIf($[ ${RND} < 55 ]?simula-operadora)
exten => s,n,GotoIf($[ ${RND} < 65 ]?simula-maquina)
exten => s,n,GotoIf($[ ${RND} < 75 ]?simula-naoatende)
exten => s,n,GotoIf($[ ${RND} < 85 ]?simula-isdn-descarte)
exten => s,n,GotoIf($[ ${RND} < 90 ]?simula-isdn-erro)
exten => s,n,GotoIf($[ ${RND} == 110 ]?simula-encaminha)


exten => s,n(simula-humano),NoOp(Simulacao - HUMANO - (${RND}))

exten => s,n,Ringing()
exten => s,n,Wait(5)

exten => s,n,Playback(atendimento-humano)
exten => s,n,Goto(moh)

exten => s,n(simula-ocupado),NoOp(Simulacao - OCUPADO - (${RND}))
exten => s,n,Busy()

exten => s,n(simula-naoexiste),NoOp(Simulacao - NAO EXISTE - (${RND}))
exten => s,n,Hangup(1)

exten => s,n(simula-maquina),NoOp(Simulacao - SECRETARIA ELETRONICA - (${RND}))
exten => s,n,Ringing()
exten => s,n,Wait(3)
exten => s,n,Answer()
;exten => s,n,Playback(atendimento-maquina)
exten => s,n,Playback(atendimento-maquina-vivo2)
exten => s,n,Goto(moh)

exten => s,n(simula-operadora),NoOp(Simulacao - MENSAGEM OPERADORA - (${RND}))
exten => s,n,Playback(atendimento-maquina)
exten => s,n,Hangup()

exten => s,n(simula-naoatende),NoOp(Simulacao - NAO ATENDE - (${RND}))
exten => s,n,Wait(300)
exten => s,n,Hangup()

exten => s,n(simula-isdn-descarte),NoOp(Simulacao - ISDN DESCARTE (20) - (${RND}))
exten => s,n,Hangup(20)

exten => s,n(simula-isdn-erro),NoOp(Simulacao - ISDN ERRO (58) - (${RND}))
exten => s,n,Hangup(58)

;exten => s,n(moh),MusicOnHold(default,${RAND(30,60)})
exten => s,n(moh),MusicOnHold(default,30)
exten => s,n,Hangup()

exten => s,n(simula-encaminha),NoOp(internal-phone-call - (${RND}))
exten => s,n,Ringing
exten => s,n,answer()
exten => s,n,Dial(SIP/vmrafael,12,r)



[macro-simula-pstn-x]
exten => s,1,NoOp(Simula PSTN)
exten => s,n,Wait(${RAND(1,2)})

exten => s,n,Set(TRONCO=${CHANNEL:4})
exten => s,n,Set(TRONCO=${CUT(TRONCO,-,1)})

exten => s,n,NoOp(Recebendo chamada de (num:${CALLERID(num)}) (name:${CALLERID(name)}) do tronco ${TRONCO})

exten => s,n,Set(RND=${RAND(1,10)})
exten => s,n,Set(TESTE_OC=${IF($[ "x${DB(config/${TRONCO}/ocupado)}"   != "x" ]?${DB(config/${TRONCO}/ocupado)}:8)})
exten => s,n,Set(TESTE_NA=${IF($[ "x${DB(config/${TRONCO}/naoAtende)}" != "x" ]?${DB(config/${TRONCO}/naoAtende)}:6)})
exten => s,n,GotoIf($[ ${RND} > ${TESTE_OC} ]?ocupado)
exten => s,n,Ringing()
exten => s,n,GotoIf($[ ${RND} > ${TESTE_NA} ]?naoatende)

exten => s,n(ok),Set(TOQUE_MIN=${IF($[ "x${DB(config/${TRONCO}/toqueMin)}" != "x" ]?${DB(config/${TRONCO}/toqueMin)}:2)})
exten => s,n,Set(TOQUE_MAX=${IF($[ "x${DB(config/${TRONCO}/toqueMax)}" != "x" ]?${DB(config/${TRONCO}/toqueMax)}:5)})
exten => s,n,Wait(${RAND(${TOQUE_MIN},${TOQUE_MAX})})
exten => s,n,Answer()

;exten => s,n,Goto(moh)  ;; Desativando simulacao de SE

; ========= Simulacao de secretaria eletronica ================
exten => s,n,Set(TESTE_SE=${IF($[ "x${DB(config/${TRONCO}/secEletr)}" != "x" ]?${DB(config/${TRONCO}/secEletr)}:4)})
exten => s,n,GotoIf($[ ${RAND(1,10)} > ${TESTE_SE} ]?humano)

exten => s,n,NoOp(atendimento-maquina)
exten => s,n,Playback(atendimento-maquina)
exten => s,n,Goto(moh)

exten => s,n(humano),NoOp(atendimento-humano)
exten => s,n,Playback(atendimento-humano)
;exten => s,n,Goto(moh)
; =============================================================


; ========= Simulacao de conversacao ==========================
exten => s,n(moh),Set(MOHMIN=${IF($[ "x${DB(config/${TRONCO}/mohMin)}" != "x" ]?${DB(config/${TRONCO}/mohMin)}:30)})
exten => s,n,Set(MOHMAX=${IF($[      "x${DB(config/${TRONCO}/mohMax)}" != "x" ]?${DB(config/${TRONCO}/mohMax)}:60)})
exten => s,n,MusicOnHold(default,${RAND(${MOHMIN},${MOHMAX})})
exten => s,n,Hangup()
; =============================================================


; ========= Simulacao de ocupado ==============================
exten => s,n(ocupado),Set(TESTE_CG=${IF($[ "x${DB(config/${TRONCO}/congestion)}" != "x" ]?${DB(config/${TRONCO}/congestion)}:1)})
exten => s,n,ExecIf($[ ${RAND(1,10)} > ${TESTE_CG} ]?Busy(1):Congestion(1))
exten => s,n,Hangup(${RAND(1,60)})
; =============================================================


; ========= Simulacao de Nao Atendimento ======================
exten => s,n(naoatende),Wait(200)
exten => s,n,Hangup()
; =============================================================

[khomp-00-00]
include => pstn

[entrada-vononexcore]
exten => nexcore,1,Answer()
exten => nexcore,n,DumpChan()
exten => nexcore,n,Playback(beep)
exten => nexcore,n,Playback(beep)
exten => nexcore,n,Playback(beep)
exten => nexcore,n,Hangup()

